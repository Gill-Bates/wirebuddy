# =============================================================================
# WireBuddy - Setup & Deployment
# =============================================================================

# --- Local Development Setup ---
command -v python3.13 >/dev/null 2>&1 && PYTHON=python3.13 || PYTHON=python3
$PYTHON -m venv /opt/wirebuddy/.venv
source /opt/wirebuddy/.venv/bin/activate
pip install --upgrade pip
pip install -r /opt/wirebuddy/requirements.txt

# --- Start Dev Server ---
export WIREBUDDY_SECRET_KEY="l+QGUq6BH9dLZkAQpG2jivXZeLLwYNMCmzUsfcD2wPM="
export WIREBUDDY_DATA_DIR="/opt/python/wirebuddy/data"
export LOG_LEVEL="DEBUG"

cd /opt/wirebuddy && source .venv/bin/activate && python main.py

# --- Docker Login ---
docker login docker.cirrio.de
docker login  # Docker Hub

# --- Build & Push Image ---
cd /opt/wirebuddy && \
VERSION="$(cat VERSION | tr -d '\r\n')" && \
if [ -z "$VERSION" ]; then echo "VERSION is empty" >&2; exit 1; fi && \
git add -A && \
git commit -m "Build $VERSION" --allow-empty && \
git rev-parse HEAD > BUILD_INFO && \
docker buildx build --platform linux/amd64 \
  -t "docker.cirrio.de/wirebuddy:${VERSION}" \
  -t "docker.cirrio.de/wirebuddy:latest" \
  --push .

# --- Deploy on Host ---
docker compose down && docker compose pull && docker compose up -d

# Housekeeping
docker compose -f docker-compose_local.yml up --build -d


# Prune
docker system prune -af
docker buildx prune -af